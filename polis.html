<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EGM - Adli Kontrol Sistemi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        police: { dark: '#0b1121', panel: '#151e32', blue: '#3b82f6', red: '#ef4444' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body { background-color: #0b1121; color: #e2e8f0; overflow: hidden; -webkit-tap-highlight-color: transparent; height: 100dvh; }
        .glass-panel { background: rgba(21, 30, 50, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.9rem; line-height: 1.4; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chat-bubble.me { background: #2563eb; color: white; border-bottom-right-radius: 4px; margin-left: auto; }
        .chat-bubble.other { background: #1e293b; color: #e2e8f0; border-bottom-left-radius: 4px; margin-right: auto; }
        .chat-bubble.system { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; width: 100%; text-align: center; font-size: 0.75rem; margin: 10px 0; font-family: 'Fira Code', monospace; }
        
        /* Mobil KaydÄ±rma ve DÃ¼zen */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        input, textarea { font-size: 16px !important; } /* Mobil zoom engelleme */
        
        /* GeÃ§iÅŸ Efekti */
        .view-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; }
    </style>
</head>
<body class="flex flex-col font-sans">

    <header class="h-16 bg-[#0b1121] border-b border-white/5 flex items-center justify-between px-4 shrink-0 z-40">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-900/40">
                <i class="fa-solid fa-shield-halved text-white text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-white text-xs md:text-sm tracking-wide uppercase">EGM Adli Sistem</h1>
                <p id="subTitle" class="text-[9px] text-blue-400 font-mono animate-pulse uppercase">BaÄŸlanÄ±lÄ±yor...</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
             <button id="complaintBtn" onclick="openComplaintModal()" class="hidden bg-red-600/20 text-red-500 border border-red-600/50 px-3 py-2 rounded-lg text-[10px] font-bold hover:bg-red-600 hover:text-white transition">
                 <i class="fa-solid fa-bullhorn mr-1"></i> ÅžÄ°KAYET
             </button>
             <button onclick="window.location.href='mm (2).html'" class="text-gray-400 hover:text-white bg-white/5 p-2.5 rounded-lg"><i class="fa-solid fa-house"></i></button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <aside class="w-full md:w-80 bg-[#0f172a] border-r border-white/5 flex flex-col z-20 h-full shrink-0">
            <div id="policeTabs" class="grid grid-cols-2 p-3 gap-2 border-b border-white/5 hidden">
                <button onclick="switchTab('cases')" id="btn-cases" class="py-2.5 text-[10px] font-bold rounded-lg bg-blue-600 text-white uppercase shadow-lg transition">Dosyalar</button>
                <button onclick="switchTab('citizens')" id="btn-citizens" class="py-2.5 text-[10px] font-bold rounded-lg hover:bg-white/5 text-gray-400 uppercase transition">GBT Sorgu</button>
            </div>
            
            <div id="searchContainer" class="p-3 border-b border-white/5 hidden">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Ä°sim veya TC No..." class="w-full bg-black/30 border border-white/10 rounded-xl py-2.5 pl-9 pr-3 text-xs text-white outline-none focus:border-blue-500 transition">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-500 text-xs"></i>
                </div>
            </div>

            <div id="listArea" class="flex-1 overflow-y-auto p-2 space-y-2 pb-24">
                <div class="flex flex-col items-center justify-center h-40 text-gray-600">
                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                    <span class="text-[10px] uppercase font-bold tracking-widest">Sistem HazÄ±rlanÄ±yor</span>
                </div>
            </div>
        </aside>

        <section id="mainArea" class="hidden md:flex flex-1 flex-col bg-[#0b1121] fixed inset-0 z-[50] md:static md:z-10 view-transition transform translate-x-full md:translate-x-0">
            
            <div class="md:hidden h-16 border-b border-white/10 flex items-center gap-4 px-4 bg-[#0f172a] shadow-lg shrink-0">
                <button onclick="closeMainArea()" class="w-10 h-10 rounded-full bg-white/5 text-white flex items-center justify-center active:scale-90 transition"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="flex-1 overflow-hidden">
                    <h3 id="chatHeaderTitle" class="font-bold text-white text-sm truncate uppercase">---</h3>
                    <p id="chatHeaderSub" class="text-[10px] text-blue-400 font-mono">Detaylar YÃ¼kleniyor</p>
                </div>
                <button id="actionBtnMobile" onclick="openActionModal()" class="w-10 h-10 rounded-xl bg-red-600/20 text-red-500 flex items-center justify-center hidden active:scale-90 transition"><i class="fa-solid fa-gavel"></i></button>
            </div>

            <header class="hidden md:flex h-16 border-b border-white/5 items-center justify-between px-6 bg-[#0f172a]/50 backdrop-blur shrink-0">
                <div>
                    <h2 id="desktopTitle" class="text-lg font-bold text-white uppercase tracking-tight">DOSYA SEÃ‡Ä°LMEDÄ°</h2>
                    <p id="desktopSub" class="text-[10px] text-gray-500 font-mono">LÃ¼tfen listeden bir kayÄ±t seÃ§iniz.</p>
                </div>
                <div id="policeActions" class="hidden gap-2">
                    <button onclick="openActionModal()" class="bg-red-600 hover:bg-red-500 text-white px-5 py-2.5 rounded-xl text-[10px] font-bold uppercase shadow-lg active:scale-95 transition">ADLÄ° HÃœKÃœM</button>
                    <button onclick="closeActiveCase()" class="bg-gray-700 hover:bg-gray-600 text-white px-5 py-2.5 rounded-xl text-[10px] font-bold uppercase active:scale-95 transition">DOSYAYI KAPAT</button>
                </div>
            </header>

            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#0b1121] scroll-smooth">
                <div id="emptyChatState" class="h-full flex flex-col items-center justify-center text-gray-700 opacity-40">
                    <i class="fa-solid fa-scale-unbalanced-flip text-7xl mb-6"></i>
                    <p class="font-bold uppercase tracking-widest text-sm text-center">Dosya SeÃ§imi Bekleniyor</p>
                </div>
            </div>

            <div id="inputArea" class="p-4 border-t border-white/5 bg-[#0f172a] hidden shrink-0 safe-area-bottom">
                <form id="chatForm" class="flex gap-2 max-w-5xl mx-auto w-full">
                    <input id="messageInput" type="text" autocomplete="off" placeholder="MesajÄ±nÄ±zÄ± veya ifadenizi yazÄ±n..." class="flex-1 bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white focus:border-blue-500 outline-none transition shadow-inner">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition"><i class="fa-solid fa-paper-plane text-xl"></i></button>
                </form>
            </div>
        </section>
    </main>

    <div id="complaintModal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-[#151e32] border border-white/10 w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="font-black text-white mb-2 text-xl uppercase italic">ADLÄ° ÅžÄ°KAYET</h3>
            <p class="text-xs text-gray-400 mb-6">SuÃ§ duyurusunda bulunmak istediÄŸiniz ÅŸahsÄ±n bilgilerini eksiksiz girin.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-500 uppercase font-bold mb-1.5 block">ÅžÃ¼pheli TC / UID</label>
                    <input type="text" id="targetUid" placeholder="TC NumarasÄ±nÄ± YapÄ±ÅŸtÄ±rÄ±n" class="w-full bg-black/40 border border-white/10 rounded-xl p-3.5 text-white text-sm focus:border-red-500 outline-none transition">
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 uppercase font-bold mb-1.5 block">SuÃ§ DetayÄ± ve Åžikayet</label>
                    <textarea id="complaintText" rows="3" placeholder="OlayÄ± detaylÄ±ca aÃ§Ä±klayÄ±n..." class="w-full bg-black/40 border border-white/10 rounded-xl p-3.5 text-white text-sm focus:border-red-500 outline-none transition"></textarea>
                </div>
            </div>
            
            <div class="flex gap-3 mt-8">
                <button onclick="document.getElementById('complaintModal').classList.add('hidden')" class="flex-1 bg-gray-800 text-gray-400 py-4 rounded-xl text-[10px] font-bold uppercase tracking-widest active:scale-95 transition">VazgeÃ§</button>
                <button onclick="submitComplaint()" class="flex-1 bg-red-600 text-white py-4 rounded-xl text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-red-900/40 active:scale-95 transition">GÃ¶nder</button>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-[#151e32] border border-white/10 w-full max-w-md rounded-3xl p-7 shadow-2xl">
            <h3 class="text-2xl font-black text-white mb-6 uppercase italic">YARGI PANELÄ°</h3>
            <div class="grid grid-cols-3 gap-3 mb-8">
                <button onclick="setModal('fine')" class="p-4 rounded-2xl bg-white/5 border border-white/5 text-center flex flex-col items-center gap-3 active:scale-95 transition">
                    <i class="fa-solid fa-money-bill text-yellow-500 text-2xl"></i>
                    <span class="text-[9px] font-bold uppercase">Ceza</span>
                </button>
                <button onclick="setModal('jail')" class="p-4 rounded-2xl bg-white/5 border border-white/5 text-center flex flex-col items-center gap-3 active:scale-95 transition">
                    <i class="fa-solid fa-lock text-red-500 text-2xl"></i>
                    <span class="text-[9px] font-bold uppercase">Hapis</span>
                </button>
                <button onclick="setModal('clean')" class="p-4 rounded-2xl bg-white/5 border border-white/5 text-center flex flex-col items-center gap-3 active:scale-95 transition">
                    <i class="fa-solid fa-broom text-blue-500 text-2xl"></i>
                    <span class="text-[9px] font-bold uppercase">Sicil</span>
                </button>
            </div>
            <div id="modalActionForm" class="space-y-4"></div>
            <button onclick="closeModal()" class="w-full mt-6 py-3 text-[10px] text-gray-500 font-bold uppercase border border-white/5 rounded-xl hover:text-white transition">Kapat</button>
        </div>
    </div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[150] hidden bg-gray-900/90 border border-white/20 text-white px-8 py-4 rounded-2xl shadow-2xl font-bold flex items-center gap-4 transition-all transform -translate-y-20 opacity-0 whitespace-nowrap backdrop-blur-md"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, query, where, onSnapshot, addDoc, updateDoc, orderBy, serverTimestamp, runTransaction, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBlirRiiNPpdqmTAmq6DsSq8mCUlgBHgVc",
            authDomain: "lilemir-new.firebaseapp.com",
            databaseURL: "https://lilemir-new-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lilemir-new",
            storageBucket: "lilemir-new.firebasestorage.app",
            messagingSenderId: "339863121380",
            appId: "1:339863121380:web:123195552e821b085e6bf1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isPolice = false;
        let activeTab = 'cases';
        let activeCaseId = null;
        let activeSuspectId = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = { id: user.uid, ...snap.data() };
                    isPolice = ['Polis', 'Admin', 'Komiser'].includes(currentUser.role);
                    setupUI();
                }
            } else window.location.href = 'mm (2).html';
        });

        function setupUI() {
            document.getElementById('subTitle').innerText = isPolice ? "Emniyet Personel Paneli" : "VatandaÅŸ Adli Portal";
            document.getElementById('subTitle').classList.remove('animate-pulse');
            
            if (isPolice) {
                document.getElementById('policeTabs').classList.remove('hidden');
                document.getElementById('searchContainer').classList.remove('hidden');
                switchTab('cases');
            } else {
                document.getElementById('complaintBtn').classList.remove('hidden');
                loadMyCases();
            }
        }

        // --- LÄ°STELEME ---
        window.switchTab = (tab) => {
            activeTab = tab;
            const b1 = document.getElementById('btn-cases');
            const b2 = document.getElementById('btn-citizens');
            b1.className = tab === 'cases' ? "py-2.5 text-[10px] font-bold rounded-lg bg-blue-600 text-white uppercase shadow-lg transition" : "py-2.5 text-[10px] font-bold rounded-lg hover:bg-white/5 text-gray-400 uppercase transition";
            b2.className = tab === 'citizens' ? "py-2.5 text-[10px] font-bold rounded-lg bg-blue-600 text-white uppercase shadow-lg transition" : "py-2.5 text-[10px] font-bold rounded-lg hover:bg-white/5 text-gray-400 uppercase transition";
            
            if(tab === 'cases') loadAllCases();
            else loadCitizens();
        }

        function loadAllCases() {
            const q = query(collection(db, "investigations"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('listArea');
                list.innerHTML = '';
                if(snap.empty) list.innerHTML = `<div class="p-8 text-center text-[10px] text-gray-600 font-bold uppercase tracking-widest">Dosya bulunamadÄ±.</div>`;
                snap.forEach(d => {
                    const r = d.data();
                    const el = document.createElement('div');
                    el.className = `p-4 rounded-2xl bg-[#151e32] border border-white/5 cursor-pointer hover:bg-white/10 transition flex justify-between items-center mb-2 ${activeCaseId === d.id ? 'border-blue-500/50 bg-blue-900/10' : ''}`;
                    el.onclick = () => openCase(d.id, r);
                    el.innerHTML = `
                        <div class="min-w-0">
                            <div class="text-[11px] font-black text-white uppercase truncate">${r.title}</div>
                            <div class="text-[9px] text-gray-500 mt-0.5">ÅžÃ¼pheli: ${r.suspectName}</div>
                        </div>
                        <span class="text-[8px] font-bold px-2 py-1 rounded-lg shrink-0 ml-2 ${r.status === 'open' ? 'bg-green-500/10 text-green-500 border border-green-500/20' : 'bg-gray-500/10 text-gray-400 border border-gray-500/20'}">${r.status.toUpperCase()}</span>
                    `;
                    list.appendChild(el);
                });
            });
        }

        function loadMyCases() {
            const list = document.getElementById('listArea');
            onSnapshot(collection(db, "investigations"), (snap) => {
                list.innerHTML = '';
                let hasCase = false;
                snap.forEach(d => {
                    const r = d.data();
                    if(r.suspectId === currentUser.id || r.officerId === currentUser.id) {
                        hasCase = true;
                        const el = document.createElement('div');
                        el.className = "p-4 rounded-2xl bg-[#151e32] border border-white/5 cursor-pointer hover:bg-white/10 mb-2 active:scale-95 transition";
                        el.onclick = () => openCase(d.id, r);
                        const isAccused = r.suspectId === currentUser.id;
                        el.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="min-w-0">
                                    <div class="text-[11px] font-black ${isAccused ? 'text-red-400' : 'text-blue-400'} uppercase truncate">${r.title}</div>
                                    <div class="text-[9px] text-gray-500 mt-0.5">${isAccused ? 'ÅžÃ¼pheli SÄ±fatÄ±yla' : 'MÃ¼ÅŸteki SÄ±fatÄ±yla'}</div>
                                </div>
                                <i class="fa-solid fa-chevron-right text-gray-800 text-[10px]"></i>
                            </div>
                        `;
                        list.appendChild(el);
                    }
                });
                if(!hasCase) list.innerHTML = `<div class="h-60 flex flex-col items-center justify-center text-gray-700"><i class="fa-solid fa-check-double text-4xl mb-4 text-emerald-500/20"></i><br><span class="text-[10px] font-bold uppercase tracking-widest text-center">DosyanÄ±z bulunmamaktadÄ±r</span></div>`;
            });
        }

        function loadCitizens() {
            onSnapshot(collection(db, "users"), (snap) => {
                const list = document.getElementById('listArea');
                list.innerHTML = '';
                const search = document.getElementById('searchInput').value.toLowerCase();
                snap.forEach(d => {
                    const u = d.data();
                    if(u.uid === currentUser.id) return;
                    if(search && !u.username.toLowerCase().includes(search) && !u.uid.toLowerCase().includes(search)) return;

                    const el = document.createElement('div');
                    el.className = "p-4 rounded-2xl bg-[#151e32] border border-white/5 flex justify-between items-center mb-2 active:bg-blue-900/10 transition";
                    el.innerHTML = `
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center font-bold text-xs text-white border border-white/5 shrink-0">${u.username.charAt(0)}</div>
                            <div class="min-w-0">
                                <div class="text-[11px] font-bold text-white truncate">${u.username}</div>
                                <div class="text-[9px] text-gray-500">TC: ...${u.uid.substring(0,6)}</div>
                            </div>
                        </div>
                        <button onclick="startInvestigation('${u.id}', '${u.username}')" class="bg-blue-600 text-white text-[9px] px-3 py-2 rounded-xl font-bold uppercase shadow-md active:scale-90 transition">AÃ‡</button>
                    `;
                    list.appendChild(el);
                });
            });
        }

        // --- SOHBETÄ° AÃ‡MA (MOBÄ°L DESTEKLÄ°) ---
        function openCase(caseId, data) {
            activeCaseId = caseId;
            activeSuspectId = data.suspectId;
            
            const mainArea = document.getElementById('mainArea');
            mainArea.classList.remove('hidden');
            mainArea.classList.add('flex');
            
            // Mobil Animasyon
            setTimeout(() => {
                mainArea.classList.remove('translate-x-full');
            }, 10);

            document.getElementById('emptyChatState').classList.add('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
            
            // Header GÃ¼ncelleme
            document.getElementById('chatHeaderTitle').innerText = data.title;
            document.getElementById('chatHeaderSub').innerText = data.suspectName;
            document.getElementById('desktopTitle').innerText = data.title;
            document.getElementById('desktopSub').innerText = `ÅžÃ¼pheli: ${data.suspectName} | Dosya No: ${caseId.substring(0,8)}`;

            if(isPolice) {
                document.getElementById('policeActions').classList.replace('hidden', 'flex');
                document.getElementById('actionBtnMobile').classList.remove('hidden');
            } else {
                document.getElementById('policeActions').classList.add('hidden');
                document.getElementById('actionBtnMobile').classList.add('hidden');
            }

            // MesajlarÄ± Dinle
            const q = query(collection(db, "investigations", caseId, "messages"), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';
                snap.forEach(d => renderMsg(container, d.data()));
                container.scrollTop = container.scrollHeight;
            });
        }

        window.closeMainArea = () => {
            const mainArea = document.getElementById('mainArea');
            mainArea.classList.add('translate-x-full');
            setTimeout(() => {
                mainArea.classList.add('hidden');
                mainArea.classList.remove('flex');
                activeCaseId = null;
            }, 300);
        }

        function renderMsg(container, m) {
            if(m.uid === 'SYSTEM') {
                container.innerHTML += `<div class="chat-bubble system">${m.text}</div>`;
                return;
            }
            const isMe = m.uid === currentUser.id;
            container.innerHTML += `
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-[slide-up_0.3s_ease-out]">
                    <span class="text-[8px] text-gray-600 mb-1 px-2 font-bold uppercase tracking-tighter">${m.sender}</span>
                    <div class="chat-bubble ${isMe ? 'me' : 'other'}">${m.text}</div>
                </div>
            `;
        }

        // --- DÄ°ÄžER FONKSÄ°YONLAR (CEZA, ÅžÄ°KAYET VS.) ---
        document.getElementById('chatForm').onsubmit = async (e) => {
            e.preventDefault();
            const txt = document.getElementById('messageInput').value.trim();
            if(!txt || !activeCaseId) return;
            await addDoc(collection(db, "investigations", activeCaseId, "messages"), {
                text: txt, uid: currentUser.id, sender: currentUser.username, createdAt: serverTimestamp()
            });
            document.getElementById('messageInput').value = '';
        }

        window.submitComplaint = async () => {
            const target = document.getElementById('targetUid').value.trim();
            const text = document.getElementById('complaintText').value.trim();
            if(!target || !text) return showToast("BoÅŸ alan bÄ±rakmayÄ±n!", "error");
            try {
                const userSnap = await getDoc(doc(db, "users", target));
                if(!userSnap.exists()) return showToast("HatalÄ± TC NumarasÄ±!", "error");
                await addDoc(collection(db, "investigations"), {
                    title: "VATANDAÅž ÅžÄ°KAYETÄ°", suspectId: target, suspectName: userSnap.data().username,
                    officerId: currentUser.id, officerName: currentUser.username, status: 'open', createdAt: serverTimestamp()
                }).then(async (docRef) => {
                    await addDoc(collection(db, "investigations", docRef.id, "messages"), {
                        text: `ðŸ“£ ÅžÄ°KAYET Ä°HBARI: ${text}`, uid: 'SYSTEM', sender: 'SÄ°STEM', createdAt: serverTimestamp()
                    });
                });
                document.getElementById('complaintModal').classList.add('hidden');
                showToast("Åžikayetiniz iletildi.", "success");
            } catch(e) { showToast("Hata!", "error"); }
        };

        window.startInvestigation = (uid, name) => {
            const title = prompt(`${name} hakkÄ±nda soruÅŸturma baÅŸlÄ±ÄŸÄ±:`);
            if(!title) return;
            addDoc(collection(db, "investigations"), {
                title: title.toUpperCase(), suspectId: uid, suspectName: name,
                officerId: currentUser.id, officerName: currentUser.username, status: 'open', createdAt: serverTimestamp()
            }).then(docRef => {
                addDoc(collection(db, "investigations", docRef.id, "messages"), {
                    text: `âš ï¸ RESMÄ° SORUÅžTURMA BAÅžLATILDI.`, uid: 'SYSTEM', sender: 'SÄ°STEM', createdAt: serverTimestamp()
                });
                switchTab('cases');
            });
        };

        window.setModal = (type) => {
            const form = document.getElementById('modalActionForm');
            if(type === 'fine') {
                form.innerHTML = `<input type="number" id="fVal" placeholder="Tutar (â‚º)" class="w-full bg-black/40 p-4 rounded-xl text-white border border-white/5 focus:border-yellow-500 outline-none transition"><button onclick="doFine()" class="w-full bg-yellow-600 py-4 rounded-xl text-xs font-bold text-black mt-2 shadow-lg active:scale-95 transition">CEZAYI UYGULA</button>`;
            } else if(type === 'jail') {
                form.innerHTML = `<input type="number" id="jVal" placeholder="Hapis SÃ¼resi (GÃ¼n)" class="w-full bg-black/40 p-4 rounded-xl text-white border border-white/5 focus:border-red-500 outline-none transition"><button onclick="doJail()" class="w-full bg-red-600 py-4 rounded-xl text-xs font-bold text-white mt-2 shadow-lg active:scale-95 transition">HÃœKMÃœ VER</button>`;
            } else {
                form.innerHTML = `<button onclick="doClean()" class="w-full bg-blue-600 py-4 rounded-xl text-xs font-bold text-white shadow-lg active:scale-95 transition">SÄ°CÄ°LÄ° TEMÄ°ZLE</button>`;
            }
        }

        window.doFine = async () => {
            const val = parseInt(document.getElementById('fVal').value);
            if(!val) return;
            await runTransaction(db, async(t) => {
                const ref = doc(db, "users", activeSuspectId);
                const s = await t.get(ref);
                t.update(ref, { balance: (s.data().balance || 0) - val });
            });
            await addDoc(collection(db, "investigations", activeCaseId, "messages"), { text: `âš–ï¸ HÃœKÃœM: ${val} â‚º PARA CEZASI TAHSÄ°L EDÄ°LDÄ°.`, uid: 'SYSTEM', sender: 'ADLÄ°YE', createdAt: serverTimestamp() });
            showToast("Para cezasÄ± uygulandÄ±.", "success"); closeModal();
        }

        window.doJail = async () => {
            const val = parseInt(document.getElementById('jVal').value);
            if(!val) return;
            const rDate = new Date(); rDate.setDate(rDate.getDate() + val);
            await updateDoc(doc(db, "users", activeSuspectId), { sicilDurumu: 'Hapis', bannedUntil: rDate });
            await addDoc(collection(db, "investigations", activeCaseId, "messages"), { text: `ðŸš« HÃœKÃœM: ${val} GÃœN HAPÄ°S CEZASI.`, uid: 'SYSTEM', sender: 'ADLÄ°YE', createdAt: serverTimestamp() });
            showToast("Hapis cezasÄ± verildi.", "success"); closeModal();
        }

        window.doClean = async () => {
            await updateDoc(doc(db, "users", activeSuspectId), { sicilDurumu: 'Temiz' });
            await addDoc(collection(db, "investigations", activeCaseId, "messages"), { text: `âœ… SÄ°CÄ°L AFFI UYGULANDI.`, uid: 'SYSTEM', sender: 'ADLÄ°YE', createdAt: serverTimestamp() });
            showToast("Sicil temizlendi.", "success"); closeModal();
        }

        window.closeActiveCase = async () => {
            if(!confirm("Dosya kapatÄ±lsÄ±n mÄ±?")) return;
            await updateDoc(doc(db, "investigations", activeCaseId), { status: 'closed' });
            showToast("Dosya ArÅŸivlendi.", "info");
            closeMainArea();
        }

        window.openActionModal = () => document.getElementById('actionModal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('actionModal').classList.add('hidden');
        
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.className = `fixed top-10 left-1/2 -translate-x-1/2 z-[200] px-10 py-5 rounded-2xl shadow-2xl font-black text-white flex items-center gap-4 transition-all transform duration-300 backdrop-blur-xl border border-white/20 ${type==='error'?'bg-red-600':'bg-blue-600'}`;
            t.innerHTML = `<i class="fa-solid ${type==='error'?'fa-triangle-exclamation':'fa-circle-check'} text-2xl"></i> ${msg.toUpperCase()}`;
            t.classList.remove('hidden', '-translate-y-20', 'opacity-0');
            setTimeout(() => {
                t.classList.add('-translate-y-20', 'opacity-0');
                setTimeout(()=>t.classList.add('hidden'), 300);
            }, 3000);
        }

        // Global functions
        window.switchTab = switchTab;
        window.openActionModal = openActionModal;
        window.setModal = setModal;
        window.doFine = doFine;
        window.doJail = doJail;
        window.doClean = doClean;
        window.closeActiveCase = closeActiveCase;
        window.closeModal = closeModal;
        window.closeMainArea = closeMainArea;
        window.submitComplaint = submitComplaint;
        window.openComplaintModal = openComplaintModal;
        window.startInvestigation = startInvestigation;

    </script>
</body>
</html>
